# Alexandru Toma (ait15) and Andrei Isaila (ii515)

defmodule System3 do

  def main() do
    start_test1(true)
  end

  # Local tests
  # Starting local with nr_of_peers: 5, max_broadcasts: 1000, timeout: 3000
  #
  # 0: [{1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}]
  # 4: [{1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}]
  # 2: [{1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}]
  # 3: [{1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}]
  # 1: [{1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}]
  #
  # On Docker with 5 containers
  # container0                | 1: [{1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}]
  # container0                | 2: [{1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}]
  # container0                | 4: [{1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}]
  # container0                | 3: [{1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}]
  # container0                | 0: [{1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}, {1000, 1000}]
  defp start_test1(is_local) do
    nr_of_peers = 5
    max_broadcasts = 1000
    timeout = 3000
    start(is_local, nr_of_peers, max_broadcasts, timeout)
  end

  # Starting local with nr_of_peers: 5, max_broadcasts: 10000000, timeout: 3000
  #
  # 1: [{152140, 34547}, {152140, 36227}, {152140, 26712}, {152140, 24704}, {152140, 43517}]
  # 0: [{193775, 44370}, {193775, 38663}, {193775, 36119}, {193775, 26734}, {193775, 47616}]
  # 2: [{180933, 35850}, {180933, 36590}, {180933, 27352}, {180933, 24959}, {180933, 44171}]
  # 4: [{215212, 24142}, {215212, 30578}, {215212, 18172}, {215212, 19645}, {215212, 35436}]
  # 3: [{217513, 18260}, {217513, 24208}, {217513, 13007}, {217513, 12769}, {217513, 23487}]
  #
  # On Docker with 5 containers
  # container0                | 1: [{23597, 2812}, {23597, 14742}, {23597, 3730}, {23597, 3449}, {23597, 4046}]
  # container0                | 0: [{26064, 19705}, {26064, 3222}, {26064, 7707}, {26064, 4093}, {26064, 4288}]
  # container0                | 4: [{18468, 20016}, {18468, 14729}, {18468, 17086}, {18468, 16692}, {18468, 16166}]
  # container0                | 3: [{24048, 2039}, {24048, 1393}, {24048, 7237}, {24048, 20124}, {24048, 2264}]
  # container0                | 2: [{26537, 14824}, {26537, 13261}, {26537, 26418}, {26537, 4550}, {26537, 12530}]
  defp start_test2(is_local) do
    nr_of_peers = 5
    max_broadcasts = 10_000_000
    timeout = 3000
    start(is_local, nr_of_peers, max_broadcasts, timeout)
  end

  # Starting local with nr_of_peers: 10, max_broadcasts: 10000000, timeout: 3000
  #
  # 5: [{39270, 9219}, {39270, 10518}, {39270, 9895}, {39270, 8580}, {39270, 8555}, {39270, 12398}, {39270, 9063}, {39270, 8242}, {39270, 7370}, {39270, 8522}]
  # 9: [{37408, 8837}, {37408, 10340}, {37408, 9334}, {37408, 8045}, {37408, 7389}, {37408, 11811}, {37408, 8578}, {37408, 6999}, {37408, 6764}, {37408, 8397}]
  # 3: [{34574, 10749}, {34574, 11654}, {34574, 10956}, {34574, 9393}, {34574, 9690}, {34574, 13527}, {34574, 10466}, {34574, 9398}, {34574, 8428}, {34574, 9914}]
  # 8: [{28916, 9617}, {28916, 10962}, {28916, 10210}, {28916, 8813}, {28916, 8981}, {28916, 12997}, {28916, 9606}, {28916, 8728}, {28916, 7837}, {28916, 9058}]
  # 7: [{34000, 10671}, {34000, 11486}, {34000, 10717}, {34000, 9392}, {34000, 9517}, {34000, 13527}, {34000, 10451}, {34000, 9398}, {34000, 8371}, {34000, 9914}]
  # 4: [{32475, 9617}, {32475, 10961}, {32475, 10208}, {32475, 8811}, {32475, 8978}, {32475, 12993}, {32475, 9604}, {32475, 8725}, {32475, 7835}, {32475, 9056}]
  # 6: [{33666, 9484}, {33666, 10830}, {33666, 10101}, {33666, 8701}, {33666, 8832}, {33666, 12844}, {33666, 9399}, {33666, 8534}, {33666, 7700}, {33666, 8905}]
  # 0: [{30086, 13712}, {30086, 14434}, {30086, 12889}, {30086, 12942}, {30086, 12403}, {30086, 17413}, {30086, 12399}, {30086, 12634}, {30086, 10632}, {30086, 12568}]
  # 1: [{43554, 8724}, {43554, 10340}, {43554, 9251}, {43554, 7979}, {43554, 7201}, {43554, 11812}, {43554, 8536}, {43554, 6831}, {43554, 6697}, {43554, 8397}]
  # 2: [{47399, 6953}, {47399, 8628}, {47399, 7084}, {47399, 6664}, {47399, 5414}, {47399, 9848}, {47399, 6190}, {47399, 5378}, {47399, 5630}, {47399, 6240}]

  # On Docker with 5 containers
  # container0                |
  # container0                | 19:43:01.036 [warn]  ** Can not start PeerSystem1::start,[5] on :"node6@container6.localdomain" **
  # container0                |
  # container0                |
  # container0                | 19:43:01.036 [warn]  ** Can not start PeerSystem1::start,[6] on :"node7@container7.localdomain" **
  # container0                |
  # container0                |
  # container0                | 19:43:01.036 [warn]  ** Can not start PeerSystem1::start,'\a' on :"node8@container8.localdomain" **
  # container0                |
  # container0                |
  # container0                | 19:43:01.036 [warn]  ** Can not start PeerSystem1::start,'\b' on :"node9@container9.localdomain" **
  # container0                |
  # container0                |
  # container0                | 19:43:01.036 [warn]  ** Can not start PeerSystem1::start,'\t' on :"node10@container10.localdomain" **
  # container0                |
  # container0                | 0: [{7912, 6965}, {7912, 5127}, {7912, 8546}, {7912, 5465}, {7912, 5479}, {7912, 0}, {7912, 0}, {7912, 0}, {7912, 0}, {7912, 0}]
  # container0                | 1: [{7414, 4649}, {7414, 4467}, {7414, 4470}, {7414, 4199}, {7414, 4002}, {7414, 0}, {7414, 0}, {7414, 0}, {7414, 0}, {7414, 0}]
  # container0                | 2: [{10626, 6648}, {10626, 6016}, {10626, 8733}, {10626, 5796}, {10626, 5109}, {10626, 0}, {10626, 0}, {10626, 0}, {10626, 0}, {10626, 0}]
  # container0                | 3: [{7225, 7377}, {7225, 7003}, {7225, 9550}, {7225, 6664}, {7225, 5717}, {7225, 0}, {7225, 0}, {7225, 0}, {7225, 0}, {7225, 0}]
  # container0                | 4: [{7446, 7912}, {7446, 6856}, {7446, 9147}, {7446, 7124}, {7446, 7446}, {7446, 0}, {7446, 0}, {7446, 0}, {7446, 0}, {7446, 0}]
  defp start_test3(is_local) do
    nr_of_peers = 10
    max_broadcasts = 10_000_000
    timeout = 3000
    start(is_local, nr_of_peers, max_broadcasts, timeout)
  end

  defp start(is_local, nr_of_peers, max_broadcasts, timeout) do
    IO.puts "Starting #{if is_local do "local" else "on docker" end} with nr_of_peers: #{nr_of_peers}, max_broadcasts: #{max_broadcasts}, timeout: #{timeout}"
    IO.puts ""

    for i <- 1..nr_of_peers do
      if is_local do
        spawn(Peer, :start, [i-1, self()])
      else
        Node.spawn(:'node#{i}@container#{i}.localdomain', Peer, :start, [i-1, self()])
      end
    end

    peers_pl = for _ <- 1..nr_of_peers do
      receive do
        {:pl_bind, peer_id, pl} -> {peer_id, pl}
      end
    end

    # send neighbours of pl
    for {peer_id, pl} <- peers_pl do
      send pl, {:bind, peers_pl}
    end

    for {peer_id, pl} <- peers_pl do
      send pl, {:bind_app, nr_of_peers}
    end

    for {peer_id, pl} <- peers_pl do
      send pl, {:broadcast_app, max_broadcasts, timeout}
    end
  end

end
